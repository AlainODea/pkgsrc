#!@SH@
# $NetBSD: scan-client-start,v 1.3 2012/11/23 12:13:35 joerg Exp $

. ${PBULK_CONF:-@PBULK_CONFIG@}

set -e

if [ "${config_version}" != "@PBULK_CONFIG_VERSION@" ]; then
	echo "Your configuration has version ${config_version}."
	echo "This version of pbulk expects version @PBULK_CONFIG_VERSION@."
	exit 1
fi

if [ -f "${bulklog}.old/meta/pscan" ]; then
	extra_pscan_args="-L ${bulklog}.old/meta/pscan"
else
	extra_pscan_args=""
fi

if [ -n "${scan_clients}" ]; then
	for client in ${scan_clients}; do
		if [ -n "${chroot_create}" -a \
		     -n "${chroot_delete}" -a \
		     -n "${chroot_dir}" ]; then
			if [ -n "${scan_chroots}" -a ${scan_chroots} -gt 1 ]; then
				ssh $client "
					i=1
					while true; do
						{ ${chroot_create} ${chroot_dir}-scan-\${i}; PBULK_CONF=${PBULK_CONF} /usr/sbin/chroot ${chroot_dir}-scan-\${i} @SH@ -c \"${pscan_prepare} && ${pscan} -c ${master_port_scan} -M ${make} ${extra_pscan_args} ${pkgsrc}\"; ${chroot_delete} ${chroot_dir}-scan-\${i}; } &
						i=\`expr \$i + 1\`
						if [ \$i -gt ${scan_chroots} ]; then
							break
						fi
					done" &
			else
				ssh $client "${chroot_create} ${chroot_dir}-scan; PBULK_CONF=${PBULK_CONF} /usr/sbin/chroot ${chroot_dir}-scan @SH@ -c \"${pscan_prepare} && ${pscan} -c ${master_port_scan} -M ${make} ${extra_pscan_args} ${pkgsrc}\"; ${chroot_delete} ${chroot_dir}-scan" &
			fi
		else
			ssh $client "PBULK_CONF=${PBULK_CONF}; export PBULK_CONF; ${pscan_prepare} && ${pscan} -c ${master_port_scan} -M ${make} ${extra_pscan_args} ${pkgsrc}" &
		fi
	done
else
	if [ -n "${chroot_create}" -a \
	     -n "${chroot_delete}" -a \
	     -n "${chroot_dir}" ]; then
		if [ -n "${scan_chroots}" -a ${scan_chroots} -gt 1 ]; then
			i=1
			while true; do
				{ ${chroot_create} ${chroot_dir}-scan-${i}; PBULK_CONF=${PBULK_CONF} /usr/sbin/chroot ${chroot_dir}-scan-${i} @SH@ -c "${pscan_prepare} && ${pscan} -c ${master_port_scan} -M ${make} ${extra_pscan_args} ${pkgsrc}"; ${chroot_delete} ${chroot_dir}-scan-${i}; } &
				i=`expr $i + 1`
				if [ $i -gt ${scan_chroots} ]; then
					break
				fi
			done
		else
			{ ${chroot_create} ${chroot_dir}-scan; PBULK_CONF=${PBULK_CONF} /usr/sbin/chroot ${chroot_dir}-scan @SH@ -c "${pscan_prepare} && ${pscan} -c ${master_port_scan} -M ${make} ${extra_pscan_args} ${pkgsrc}"; ${chroot_delete} ${chroot_dir}-scan; } &
		fi
	else
		{ PBULK_CONF=${PBULK_CONF}; export PBULK_CONF; ${pscan_prepare} && ${pscan} -c ${master_port_scan} -M ${make} ${extra_pscan_args} ${pkgsrc}; } &
	fi
fi
